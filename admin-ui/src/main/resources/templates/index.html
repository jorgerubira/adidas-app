<html xmlns:th="https://www.thymeleaf.org">
    <head>
        <title>Adidas gestión de miembros</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
        <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.css">
    </head>
    <body>
        <div class="container-fluid">
            <div class="text-center">
                <img src="/img/logo.png" height="100px"/>
            </div>
            <hr/>
            <button type='button' class='btn btn-primary ' onclick="refreshAll()"><i class='fas fa-sync-alt'></i> Refresh</button>
            <div class="row">
                <div class="col-md-6 shadow mb-4 p-3">
                    <h3>Members <button type='button' class='btn btn-primary ml-5' onclick="openDialog('template_member')"><i class='fas fa-plus'></i></button> </h3>
                    <small>Máx 10 items</small>
                    <table id="table_members"
                           data-toggle="table" 
                           data-mobile-responsive="true"
                           data-url="list_members" 
                           data-pagination="false" 
                           data-side-pagination="server"
                           class="table tclassable-stripped">
                        <thead>
                        <th data-field="name">Name</th>
                        <th data-field="email">Email</th>
                        <th data-field="points">Points</th>
                        <th data-field="id" data-formatter="btnMemberTable">Add points</th>
                        </thead>
                    </table>

                </div>
                <div class="col-md-6 shadow mb-4 p-3">
                    <h3>Sales <button type='button' class='btn btn-primary ml-5' onclick="openDialog('template_sale')"><i class='fas fa-plus'></i></button></h3>
                    <small>Máx 10 items</small>
                    <table id="table_sales"
                           data-toggle="table" 
                           data-mobile-responsive="true"
                           data-url="list_sales" 
                           data-pagination="false" 
                           data-side-pagination="server"
                           class="table tclassable-stripped">
                        <thead>
                            <th data-field="name">Name</th>
                            <th data-field="link" data-formatter="aLink">Link</th>
                            <th data-field="state">State</th>
                            <th data-field="id" data-formatter="btnSaleTable"></th>
                        </thead>
                    </table>
                </div>
                <div class="col-md-6 shadow mb-4 p-3">
                    <h3>Queue</h3>
                    <small>Máx 100 items</small>
                    <table data-toggle="table" data-url="list_queue" class="table table-stripped">
                        <thead>
                            <th data-field="name">Name</th>
                            <th data-field="sale">Sale</th>
                            <th data-field="link" data-formatter="aLink">Link</th>
                            <th data-field="points">Points</th>
                        </thead>
                    </table>
                </div>
                <div class="col-md-6 shadow mb-4 p-3">
                    <h3>Emails with error</h3>
                    <small>Máx 100 items</small>
                    <table data-toggle="table" data-url="list_emails_error" class="table table-stripped">
                        <thead>
                            <th data-field="name">Name</th>
                            <th data-field="email">Email</th>
                            <th data-field="link" data-formatter="aLink">Link</th>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
        <div id="template_member" class="d-none">
            <form action="new_member" method="post">
                <h3>New member</h3>
                <div class="form-group">
                    <label>Name</label>
                    <input name="name" class="form-control" placeholder="Enter name">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input name="email" type="email" class="form-control" placeholder="Enter email" required>
                </div>
                <button type="submit" class="btn btn-primary">New</button>
                <button type="button" onclick='closeDialog()' class="btn btn-outline-danger">Close</button>
            </form>            
        </div>
        <div id="template_member_delete" class="d-none">
            <form action="delete_member" method="post" class="text-center">
                <h3 class="m-4">Delete member. Are your sure?</h3>
                <button type="submit" class="btn btn-danger">Delete</button>
                <button type="button" onclick='closeDialog()' class="btn btn-outline-secondary">Close</button>
            </form>            
        </div>
        <div id="template_sale" class="d-none">
            <form action="new_sale" method="post">
                <h3>New sale</h3>
                <div class="form-group">
                    <label>Name</label>
                    <input name="name" class="form-control" placeholder="Enter name">
                </div>
                <div class="form-group">
                    <label>Link</label>
                    <input name="link" class="form-control" placeholder="Enter link" required>
                </div>
                <button type="submit" class="btn btn-primary">New</button>
                <button type="button" onclick='closeDialog()' class="btn btn-outline-danger">Close</button>
            </form>            
        </div>        
        <script src="https://code.jquery.com/jquery-3.6.1.js" integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI=" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js" integrity="sha384-+sLIOodYLS7CIrQpBjl+C7nPvqq+FbNUBDunl/OZv93DB7Ln/533i8e/mZXLi/P+" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.18.3/extensions/mobile/bootstrap-table-mobile.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.5.2/bootbox.min.js" integrity="sha512-RdSPYh1WA6BF0RhpisYJVYkOyTzK4HwofJ3Q7ivt/jkpW6Vc8AurL1R+4AUcvn9IwEKAPm/fk7qFZW3OuiUDeg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

        <script>
                  function openDialog(id, action) {
                      bootbox.dialog({
                          message: "<div id='formEnviar'>" + $("#" + id).html() + "</div>",
                          size: "xl"
                      });
                      if (action != null) {
                          $("#formEnviar form").attr('action', action);
                      }
                  }
                  function closeDialog() {
                      bootbox.hideAll();
                  }
                  function btnMemberTable(value, row, idx) {
                      return "<button type='button' class='btn btn-primary' onclick=\"addPoints('" + value + "')\"><i class='fas fa-coins'></i> Add points</button>" +
                              "<button type='button' class='btn btn-outline-danger ml-1' onclick=\"openDialog('template_member_delete','delete_member/" + value + "')\"><i class='fas fa-minus'></i> Delete </button>";
                  }
                  function addPoints(id) {
                      $.ajax({
                          url: '/add_point_member/' + id,
                          type: 'put',
                          success: function () {
                              $("#table_members").bootstrapTable('refresh');
                          },
                          error: function (er) {
                              alert(er);
                          }
                      });
                  }
                  function btnSaleTable(value, row, idx) {
                      if (row['state']=='PENDING'){
                          return "<button type='button' class='btn btn-primary' onclick=\"initQueue('" + value + "')\"><i class='fas fa-envelope'></i> Start Queue</button>";
                      }
                      if (row['state']=='ACTIVE'){
                          return "<button type='button' class='btn btn-primary' onclick=\"pauseQueue('" + value + "')\"><i class='fas fa-pause'></i> Pause</button>";
                      }
                      if (row['state']=='PAUSE'){
                          return "<button type='button' class='btn btn-primary' onclick=\"restartQueue('" + value + "')\"><i class='fas fa-play'></i> Restart</button>";
                      }
                  }
                  function aLink(value, row, idx) {
                      return "<a href='" + value + "' target='_blank' >" + value + "</a>";
                  }
                  function ajaxPutQueue(url){
                      $.ajax({
                          url: url,
                          type: 'put',
                          success: function () {
                              $("#table_sales").bootstrapTable('refresh');
                          },
                          error: function (info, er) {
                              alert(er);
                          }
                      });
                  }
                  
                  function initQueue(id) {
                      ajaxPutQueue('/init_queue/' + id);
                  }
                  function pauseQueue(id) {
                      ajaxPutQueue('/pause_queue/' + id);
                  }
                  function restartQueue(id) {
                      ajaxPutQueue('/restart_queue/' + id);
                  }
                  function refreshAll(){
                      $("table[data-toggle='table']").bootstrapTable('refresh');
                  }


        </script>
    </body>
</html>
